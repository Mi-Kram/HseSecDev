# ADR-001: RFC 7807 Error Handling
Дата: 2025-01-19
Статус: Accepted

## Context

В текущей реализации Wish List Service используется простая обработка ошибок через JSONResponse с базовой структурой `{"error": {"code": ..., "message": ...}}`. Это не соответствует стандартам RFC 7807 для обработки проблем в HTTP API, что может привести к:

- Несогласованности в формате ошибок между разными эндпоинтами
- Отсутствию correlation_id для трассировки ошибок
- Недостаточной информации для клиентов API
- Потенциальной утечке внутренней информации через сообщения об ошибках

## Decision

Реализовать обработку ошибок согласно RFC 7807 Problem Details for HTTP APIs:

1. **Стандартизировать формат ошибок** с полями:
   - `type`: URI идентификатор типа проблемы
   - `title`: Краткое описание проблемы
   - `status`: HTTP статус код
   - `detail`: Детальное описание проблемы
   - `correlation_id`: Уникальный идентификатор для трассировки
   - `instance`: URI конкретного вхождения проблемы

2. **Создать централизованный обработчик** для всех типов исключений

3. **Маскировать внутренние детали** в production окружении

4. **Добавить структурированное логирование** с correlation_id

## Alternatives

### Альтернатива 1: Текущий подход (отклонена)
- **Плюсы**: Простота реализации
- **Минусы**: Нестандартный формат, отсутствие трассировки, потенциальные утечки данных

### Альтернатива 2: GraphQL-стиль ошибок (отклонена)
- **Плюсы**: Гибкость для GraphQL API
- **Минусы**: Не подходит для REST API, избыточность

### Альтернатива 3: RFC 7807 (принята)
- **Плюсы**: Стандартизированный подход, трассировка, безопасность
- **Минусы**: Небольшое увеличение сложности

## Consequences

### Положительные:
- **Стандартизация**: Соответствие RFC 7807 улучшает совместимость с клиентами
- **Трассировка**: correlation_id позволяет отслеживать ошибки в логах
- **Безопасность**: Маскирование внутренних деталей предотвращает утечки информации
- **DX**: Улучшенный developer experience для API клиентов

### Отрицательные:
- **Сложность**: Небольшое увеличение кода для обработки ошибок
- **Размер ответа**: Немного больший размер JSON ответов

### Влияние на производительность:
- Минимальное влияние на производительность
- Добавление correlation_id требует генерации UUID

## Security Impact

- **NFR-04**: Улучшает конфиденциальность через маскирование внутренних деталей
- **R10**: Снижает риск утечки внутренней логики через ошибки
- **F3-I**: Предотвращает утечку информации через сообщения об ошибках

## Rollout Plan

1. **Этап 1**: Создать RFC 7807 обработчик и модели
2. **Этап 2**: Обновить существующие обработчики исключений
3. **Этап 3**: Добавить тесты для всех сценариев ошибок
4. **Этап 4**: Обновить документацию API

## Links

- NFR-04 (конфиденциальность данных)
- R10 (утечка внутренней логики через ошибки)
- F3-I (утечка внутренней логики)
- tests/test_rfc7807_errors.py::test_error_format_standard
- tests/test_rfc7807_errors.py::test_correlation_id_present
