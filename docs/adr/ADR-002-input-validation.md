# ADR-002: Enhanced Input Validation
Дата: 2025-01-19
Статус: Accepted

## Context

Текущая валидация входных данных в Wish List Service ограничена базовой Pydantic валидацией. Это создает следующие риски:

- Отсутствие проверки на SQL injection в строковых полях
- Нет валидации длины и формата текстовых полей
- Отсутствие санитизации HTML/XML контента
- Нет проверки на path traversal в файловых операциях
- Отсутствие валидации числовых диапазонов и форматов

Эти уязвимости могут привести к:
- Атакам через модификацию данных (R2, R6, R11, R12)
- Утечке информации через некорректные данные (R3, R5)
- Нарушению целостности данных

## Decision

Реализовать многоуровневую валидацию входных данных:

1. **Pydantic модели с расширенными валидаторами**:
   - Ограничения длины строк (1-1000 символов)
   - Регулярные выражения для валидации форматов
   - Санитизация HTML/XML тегов
   - Валидация числовых диапазонов

2. **Дополнительная валидация на уровне контроллеров**:
   - Проверка на SQL injection паттерны
   - Валидация путей файлов против path traversal
   - Проверка MIME типов для загружаемых файлов

3. **Централизованные валидаторы**:
   - `validate_text_content()` - для текстовых полей
   - `validate_numeric_range()` - для числовых значений
   - `validate_file_path()` - для файловых операций

## Alternatives

### Альтернатива 1: Только Pydantic валидация (отклонена)
- **Плюсы**: Простота, автоматическая валидация
- **Минусы**: Недостаточная защита от сложных атак

### Альтернатива 2: Внешние библиотеки валидации (отклонена)
- **Плюсы**: Готовые решения
- **Минусы**: Дополнительные зависимости, потенциальные уязвимости

### Альтернатива 3: Многоуровневая валидация (принята)
- **Плюсы**: Комплексная защита, контроль над процессом
- **Минусы**: Больше кода для поддержки

## Consequences

### Положительные:
- **Безопасность**: Значительное снижение рисков R2, R3, R5, R6, R11, R12
- **Надежность**: Предотвращение некорректных данных в системе
- **Соответствие NFR-04**: 100% валидация входных данных

### Отрицательные:
- **Производительность**: Небольшое увеличение времени обработки запросов
- **Сложность**: Больше кода для поддержки валидации
- **Размер ответов**: Более детальные сообщения об ошибках валидации

### Влияние на производительность:
- Ожидаемое увеличение времени обработки на 5-10%
- Дополнительная нагрузка на CPU для регулярных выражений

## Security Impact

- **NFR-04**: Обеспечивает 100% валидацию входных данных
- **R2**: Предотвращает модификацию данных через некорректный ввод
- **R3**: Защищает от утечки данных через валидацию форматов
- **R6**: Предотвращает модификацию бизнес-логики
- **R11, R12**: Защищает от модификации данных в хранилище
- **F1-T, F3-T, F4-T, F5-T**: Снижает риски tampering

## Rollout Plan

1. **Этап 1**: Создать расширенные Pydantic модели с валидаторами
2. **Этап 2**: Реализовать централизованные валидаторы
3. **Этап 3**: Обновить контроллеры с дополнительной валидацией
4. **Этап 4**: Добавить тесты для всех сценариев валидации
5. **Этап 5**: Обновить документацию API

## Links

- NFR-04 (валидация входных данных)
- R2, R3, R5, R6, R11, R12 (риски модификации и утечки данных)
- F1-T, F3-T, F4-T, F5-T (угрозы tampering)
- tests/test_input_validation.py::test_sql_injection_prevention
- tests/test_input_validation.py::test_path_traversal_prevention
- tests/test_input_validation.py::test_html_sanitization
